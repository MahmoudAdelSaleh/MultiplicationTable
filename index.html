<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🎲 جدول الضرب للأطفال</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1982c4">
<style>
/* CSS Styles */
body {
  font-family: 'Cairo', sans-serif;
  background-color: #fef6e4;
  text-align: center;
  margin: 0;
  padding-top: 60px;
  direction: rtl;
}
.top-tabs {
  position: fixed; top: 0; width: 100%; background: #1982c4; display: flex; z-index: 999;
}
.top-tabs button {
  flex: 1; color: white; padding: 10px; font-size: 1.2em; border: none; background: #1982c4; cursor: pointer; transition: background 0.3s;
}
.top-tabs button:hover {
  background: #f96d00;
}
.top-tabs button.active-tab {
  background: #ff914d;
}
#time-bar, #quiz-time-bar {
  position: fixed; top: 45px; left: 0; height: 10px; background: green; width: 0%; z-index: 1000;
  border-radius: 4px; transition: width linear;
}
.title-box {
  display: inline-block;
  background: linear-gradient(90deg, silver, gold, #b9f2ff, gold, silver);
  color: black;
  padding: 8px 16px;
  border-radius: 15px;
  font-size: 2.2em;
  margin: 10px auto;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}
.lang-toggle { display: flex; justify-content: center; gap: 20px; margin: 10px 0; }
.lang-btn {
  width: 50px; height: 50px; border-radius: 50%; border: none; color: white; font-size: 1.2em; font-weight: bold;
  cursor: pointer; transition: background 0.3s;
}
.lang-btn.active { background: green; }
.lang-btn.inactive { background: red; }
#result {
  font-size: 1.4em;
  background: #222; color: #0f0; padding: 6px;
  border-radius: 10px; margin: 10px auto;
  width: 95%; max-width: 500px;
  box-shadow: inset 0 0 8px #0f0, 0 0 10px rgba(0,0,0,0.4);
}
.numbers-wrapper { display: flex; justify-content: center; align-items: center; margin: 10px 0; }
.group-box {
  background: #fff; border: 2px solid #1982c4; border-radius: 10px; padding: 5px;
  display: flex; flex-wrap: wrap; justify-content: center; max-width: 160px;
}
.num {
  background: #1982c4; color: white; border-radius: 8px; margin: 3px;
  width: 40px; height: 40px; display: flex; justify-content: center; align-items: center;
  font-size: 1.2em; cursor: pointer; transition: all 0.2s; font-weight: bold;
  user-select: none;
}
.num:hover {
  background: #f96d00; transform: scale(1.1);
}
.num.selected { background: #ff914d; font-size: 1.5em; transform: scale(1.2); }
.operator-box {
  font-size: 4em; font-weight: bold; margin: 0 20px;
  animation: rotateY 2s linear infinite;
  user-select: none;
}
@keyframes rotateY {
  0% { transform: rotateY(0deg); }
  100% { transform: rotateY(360deg); }
}
.tab { display: none; }
.tab.active { display: block; }
.reset-btn {
  background: #1982c4; color: white; border-radius: 8px; padding: 6px 12px;
  margin-top: 10px; cursor: pointer; border: none; font-size: 1em; transition: background 0.3s;
}
.reset-btn:hover {
  background: #f96d00;
}
.quiz-options {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin: 10px auto;
  max-width: 90%;
  flex-wrap: nowrap; /* Force single row for options */
  overflow-x: auto; /* Allow horizontal scrolling if content overflows */
  padding-bottom: 10px; /* Add some padding for scrollbar if needed */
}
.quiz-option {
  background: #1982c4;
  color: white;
  border-radius: 8px;
  padding: 6px 12px;
  font-size: 1.8em;
  cursor: pointer;
  flex: 1;
  transition: background 0.3s, transform 0.2s;
  min-width: 80px;
  text-align: center;
  display: flex; /* Ensure content inside is centered */
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: relative;
}
.quiz-option:hover { background: #f96d00; transform: scale(1.05); }
.quiz-option.clicked {
  pointer-events: none;
}
.quiz-option.correct {
  background-color: green!important;
}
.quiz-option.wrong {
  background-color: red!important;
}

/* New styles for the separate score display container */
#quiz-score-display {
  display: flex;
  flex-wrap: wrap; /* Allows wrapping into multiple rows */
  justify-content: center;
  gap: 8px; /* Space between dots */
  margin-top: 20px; /* Space below quiz options */
  padding: 10px;
  background-color: #e0f2f7; /* Light background for distinction */
  border-radius: 10px;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
  box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
}

/* Styles for individual score dots */
.score-dot {
  width: 20px; /* Slightly larger for visibility */
  height: 20px;
  border-radius: 50%;
  opacity: 0;
  transform: scale(0.5);
  transition: opacity 0.3s ease-out, transform 0.3s ease-out;
  display: flex; /* For centering potential icons later if needed */
  align-items: center;
  justify-content: center;
  font-size: 0.8em; /* For potential icons */
  color: white;
}

.score-dot.show {
  opacity: 1;
  transform: scale(1);
}

.score-dot.correct {
  background-color: #4CAF50; /* Green */
}

.score-dot.wrong {
  background-color: #F44336; /* Red */
}

.score-dot.timeout {
  background-color: #FFC107; /* Yellow */
}

#quiz-question { margin-top:10px; font-size:2em; }
.footer {
  background: linear-gradient(90deg, #c0c0c0, #dcdcdc, #c0c0c0);
  padding: 6px 0; overflow: hidden; height: 40px; width: 100%; position: fixed; bottom: 0;
  box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
}
.footer-content {
  white-space: nowrap;
  animation: scroll-right 15s linear infinite;
  font-size: 1.2em;
}
@keyframes scroll-right {
  from { transform: translateX(-100%); }
  to { transform: translateX(100%); }
}
.footer-text {
  color: gold; text-shadow: 1px 1px 2px black, 0 0 5px gold;
  margin-right: 10px;
}
.footer-content a img {
  vertical-align: middle; margin: 0 6px; width: 24px; height: 24px;
  filter: drop-shadow(1px 1px 1px black) brightness(1.1);
  transition: transform 0.3s;
}
.footer-content a img:hover { transform: scale(1.2); }
</style>
</head>
<body>

<div id="time-bar"></div>
<div id="quiz-time-bar"></div>

<div class="top-tabs">
  <button id="tab-train-btn" class="active-tab" onclick="openTab('tab-train', this)">🎲 تدريب</button>
  <button id="tab-quiz-btn" onclick="openTab('tab-quiz', this)">🧪 اختبار</button>
  <button id="tab-settings-btn" onclick="openTab('tab-settings', this)">⚙️ إعدادات</button>
</div>

<div class="tab active" id="tab-train">
  <div class="title-box">جدول الضرب للأطفال</div>
  <div class="lang-toggle">
    <button id="btn-ar" class="lang-btn active" onclick="switchLang(true)">١٢٣</button>
    <button id="btn-en" class="lang-btn inactive" onclick="switchLang(false)">123</button>
  </div>
  <div id="result"><p>🥳 اختر الأرقام!</p></div>
  <div class="numbers-wrapper">
    <div class="group-box" id="left"></div>
    <div class="operator-box">×</div>
    <div class="group-box" id="right"></div>
  </div>
  <button class="reset-btn" onclick="resetScreen()">🔄 مسح الشاشة</button>
</div>

<div class="tab" id="tab-quiz">
  <div class="title-box">🧪 اختبار (<span id="level-selected">مبتدئ</span>)</div>
  <div id="quiz-question">?</div>
  <div class="quiz-options" id="quiz-options"></div>
  <div id="quiz-feedback" style="margin-top:8px; font-size:1.1em;"></div>
  <div id="score-text">✅ 0 | ❌ 0 | 0%</div>
  <div id="quiz-score-display"></div>
  <div style="margin-top:10px;">
    <button class="reset-btn" onclick="selectLevel('مبتدئ')">مبتدئ</button>
    <button class="reset-btn" onclick="selectLevel('نشيط')">نشيط</button>
    <button class="reset-btn" onclick="selectLevel('ذكي')">ذكي</button>
    <button class="reset-btn" onclick="selectLevel('عبقري')">عبقري</button>
  </div>
  <button class="reset-btn" onclick="startQuiz()">🚀 ابدأ الاختبار</button>
</div>

<div class="tab" id="tab-settings">
  <div class="title-box">⚙️ الإعدادات</div>
  <label>حجم العنوان <input type="range" min="1.5" max="4" step="0.1" value="2.2" onchange="document.querySelector('.title-box').style.fontSize=this.value+'em'"></label><br>
  <label>حجم شاشة النتيجة <input type="range" min="1" max="3" step="0.1" value="1.4" onchange="document.getElementById('result').style.fontSize=this.value+'em'"></label><br>
  <label>حجم نص السؤال <input type="range" min="1.5" max="3" step="0.1" value="2" onchange="document.getElementById('quiz-question').style.fontSize=this.value+'em'"></label><br>
  <label>حجم الأزرار <input type="range" min="1" max="3" step="0.1" value="1.8" onchange="document.querySelectorAll('.quiz-option').forEach(e=>e.style.fontSize=this.value+'em')"></label><br>
  <label>حجم النص المتحرك <input type="range" min="0.8" max="2" step="0.1" value="1.2" onchange="document.querySelector('.footer-content').style.fontSize=this.value+'em'"></label><br>
  <label>تغيير لون الخلفية <input type="color" onchange="document.body.style.backgroundColor=this.value"></label>
</div>

<div class="footer">
  <div class="footer-content">
    <span class="footer-text">محمود عادل صالح - معلم رياضيات</span>
    <a href="https://m.facebook.com/barghouthean/" target="_blank"><img src="https://cdn-icons-png.flaticon.com/512/733/733547.png" alt="فيسبوك"></a>
    <a href="https://wa.me/201552402912" target="_blank"><img src="https://cdn-icons-png.flaticon.com/512/733/733585.png" alt="واتساب"></a>
    <a href="mailto:mahmoudadelsaleh@gmail.com"><img src="https://cdn-icons-png.flaticon.com/512/732/732200.png" alt="بريد إلكتروني"></a>
  </div>
</div>

<audio id="sound-clap" src="true.mp3"></audio>
<audio id="sound-wrong" src="wrong.mp3"></audio>

<script>
// service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
  .then(reg => console.log('Service Worker registered:', reg.scope))
  .catch(err => console.error('Service Worker error:', err));
}

let useArabic = true;
let leftSelected = null, rightSelected = null;
let quiz = {
  left: 0,
  right: 0,
  correctAnswer: 0,
  correctCount: 0,
  wrongCount: 0,
  currentQuestion: 0,
  totalQuestions: 10,
  questionTimeout: 6000,
  questionTimer: null
};

// DOM elements cache
const leftGroup = document.getElementById('left');
const rightGroup = document.getElementById('right');
const timeBar = document.getElementById('time-bar');
const quizTimeBar = document.getElementById('quiz-time-bar');
const resultDisplay = document.getElementById('result');
const quizQuestionDisplay = document.getElementById('quiz-question');
const quizOptionsDisplay = document.getElementById('quiz-options');
const quizFeedbackDisplay = document.getElementById('quiz-feedback');
const scoreTextDisplay = document.getElementById('score-text');
const quizScoreDisplay = document.getElementById('quiz-score-display'); // New: Score display container
const soundClap = document.getElementById('sound-clap');
const soundWrong = document.getElementById('sound-wrong');

// Utility functions
const toArabic = n => n.toString().replace(/\d/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
const fromNumber = n => useArabic? toArabic(n) : n;

// Tab management
function openTab(tabId, btn) {
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  document.querySelectorAll('.top-tabs button').forEach(b => b.classList.remove('active-tab'));
  btn.classList.add('active-tab');
  if (tabId === 'tab-quiz') {
    // Optionally stop any training timers when switching to quiz
    if (window.showResultInterval) clearInterval(window.showResultInterval);
    timeBar.style.width = '0%';
  }
}

// Language switching
function switchLang(arabic) {
  useArabic = arabic;
  document.getElementById('btn-ar').className = arabic? 'lang-btn active' : 'lang-btn inactive';
  document.getElementById('btn-en').className =!arabic? 'lang-btn active' : 'lang-btn inactive';
  document.body.style.direction = arabic? 'rtl' : 'ltr';
  createNumberButtons();
  resetScreen();
}

// Training tab logic
function createNumberButtons() {
  leftGroup.innerHTML = '';
  rightGroup.innerHTML = '';
  for (let i = 1; i <= 10; i++) {
    ['left', 'right'].forEach(side => {
      let btn = document.createElement('div');
      btn.className = 'num';
      btn.textContent = fromNumber(i);
      btn.addEventListener('click', () => selectNumber(side, btn, i));
      (side === 'left'? leftGroup : rightGroup).appendChild(btn);
    });
  }
}

function selectNumber(side, btn, num) {
  // Reset previous selection for the same side
  if (side === 'left') {
    if (leftSelected) leftSelected.classList.remove('selected');
    leftSelected = btn;
  } else {
    if (rightSelected) rightSelected.classList.remove('selected');
    rightSelected = btn;
  }
  btn.classList.add('selected');
  showResult();
}

function showResult() {
  if (leftSelected && rightSelected) {
    let ln = parseInt(leftSelected.textContent.replace(/[٠-٩]/g, d => '0123456789'['٠١٢٣٤٥٦٧٨٩'.indexOf(d)]));
    let rn = parseInt(rightSelected.textContent.replace(/[٠-٩]/g, d => '0123456789'['٠١٢٣٤٥٦٩٨٩'.indexOf(d)]));
    resultDisplay.innerHTML = `<p>${fromNumber(ln)} × ${fromNumber(rn)} = ${fromNumber(ln * rn)}</p>`;
    // Reset and start new timer
    if (window.showResultInterval) clearInterval(window.showResultInterval);
    timeBar.style.transition = 'none';
    timeBar.style.width = '100%';
    setTimeout(() => {
      timeBar.style.transition = 'width 3s linear';
      timeBar.style.width = '0%';
      window.showResultInterval = setTimeout(() => resetScreen(), 3000);
    }, 10);
  }
}

function resetScreen() {
  if (leftSelected) leftSelected.classList.remove('selected');
  if (rightSelected) rightSelected.classList.remove('selected');
  leftSelected = rightSelected = null;
  resultDisplay.innerHTML = '<p>🥳 اختر الأرقام!</p>';
  timeBar.style.transition = 'none';
  timeBar.style.width = '0%';
  if (window.showResultInterval) clearTimeout(window.showResultInterval);
}

// Quiz tab logic
function selectLevel(level) {
  const levels = {
    'مبتدئ': { totalQuestions: 10, timeout: 6000 },
    'نشيط': { totalQuestions: 20, timeout: 4000 },
    'ذكي': { totalQuestions: 30, timeout: 3000 },
    'عبقري': { totalQuestions: 40, timeout: 2000 }
  };
  quiz.totalQuestions = levels[level].totalQuestions;
  quiz.questionTimeout = levels[level].timeout;
  document.getElementById('level-selected').textContent = level;
}

function startQuiz() {
  quiz.correctCount = 0;
  quiz.wrongCount = 0;
  quiz.currentQuestion = 0;
  scoreTextDisplay.textContent = `✅ 0 | ❌ 0 | 0%`;
  quizFeedbackDisplay.textContent = '';
  quizScoreDisplay.innerHTML = ''; // Clear score dots at quiz start
  nextQuiz();
}

function nextQuiz() {
  clearTimeout(quiz.questionTimer);
  if (quiz.currentQuestion >= quiz.totalQuestions) {
    showQuizResult();
    return;
  }

  // Clear previous classes from options
  document.querySelectorAll('.quiz-option.correct,.quiz-option.wrong').forEach(option => {
    option.classList.remove('correct', 'wrong');
  });

  quiz.currentQuestion++;
  quiz.left = Math.ceil(Math.random() * 10);
  quiz.right = Math.ceil(Math.random() * 10);
  quiz.correctAnswer = quiz.left * quiz.right;
  
  const qText = useArabic? `${fromNumber(quiz.left)} × ${fromNumber(quiz.right)} = ؟` : `${quiz.left} × ${quiz.right} =?`;
  quizQuestionDisplay.textContent = qText;
  quizFeedbackDisplay.textContent = '';

  const options = [quiz.correctAnswer];
  while (options.length < 3) {
    let fake = quiz.correctAnswer + (Math.floor(Math.random() * 5) - 2);
    if (fake > 0 &&!options.includes(fake)) {
      options.push(fake);
    }
  }
  options.sort(() => Math.random() - 0.5);

  // Options HTML without internal feedback containers
  quizOptionsDisplay.innerHTML = options.map(n =>
    `<div class="quiz-option" onclick="checkQuiz(${n}, this)">
        ${fromNumber(n)}
    </div>`).join('');
  
  // Animate quiz timer
  quizTimeBar.style.transition = 'none';
  quizTimeBar.style.width = '100%';
  setTimeout(() => {
    quizTimeBar.style.transition = `width ${quiz.questionTimeout / 1000}s linear`;
    quizTimeBar.style.width = '0%';
    quiz.questionTimer = setTimeout(() => checkQuiz(null), quiz.questionTimeout);
  }, 10);
}

// New helper function to add a score dot to the separate display
const addScoreDot = (type) => {
  const dot = document.createElement('div');
  dot.classList.add('score-dot', type);
  quizScoreDisplay.appendChild(dot);
  // Trigger animation after appending
  setTimeout(() => dot.classList.add('show'), 10);
};

function checkQuiz(selected, el) {
  clearTimeout(quiz.questionTimer);
  
  // Disable all options after selection
  document.querySelectorAll('.quiz-option').forEach(option => {
    option.style.pointerEvents = 'none';
  });

  const allOptions = Array.from(quizOptionsDisplay.children);
  
  if (selected === quiz.correctAnswer) {
    quiz.correctCount++;
    if (el) el.classList.add('correct');
    addScoreDot('correct'); // Add green dot to the separate score display
    soundClap.play();
    quizFeedbackDisplay.textContent = '✅ أحسنت!';
  } else if (selected!== null) { // Wrong answer clicked
    quiz.wrongCount++;
    if (el) el.classList.add('wrong');
    addScoreDot('wrong'); // Add red dot to the separate score display
    soundWrong.play();
    // Highlight the correct answer
    const correctAnswerEl = allOptions.find(option => option.textContent == fromNumber(quiz.correctAnswer));
    if (correctAnswerEl) correctAnswerEl.classList.add('correct');
    quizFeedbackDisplay.textContent = `❌ خطأ! الإجابة الصحيحة هي ${fromNumber(quiz.correctAnswer)}`;
  } else { // Timeout - no answer selected
    quiz.wrongCount++; // Count as wrong if no answer
    addScoreDot('timeout'); // Add yellow dot to the separate score display
    soundWrong.play(); // Play wrong sound for timeout
    quizFeedbackDisplay.textContent = `⏰ انتهى الوقت! الإجابة الصحيحة هي ${fromNumber(quiz.correctAnswer)}`;
    // Highlight the correct answer even on timeout
    const correctAnswerEl = allOptions.find(option => option.textContent == fromNumber(quiz.correctAnswer));
    if (correctAnswerEl) correctAnswerEl.classList.add('correct');
  }

  const percent = Math.round((quiz.correctCount / quiz.totalQuestions) * 100);
  scoreTextDisplay.textContent = `✅ ${fromNumber(quiz.correctCount)} | ❌ ${fromNumber(quiz.wrongCount)} | ${percent}%`;
  
  setTimeout(nextQuiz, 1500); // Wait a bit longer for feedback
}

function showQuizResult() {
  const percent = Math.round((quiz.correctCount / quiz.totalQuestions) * 100);
  let msg = '';
  if (percent > 80) {
    msg = '👍 رائع! جرب مستوى أصعب!';
  } else if (percent > 50) {
    msg = '✨ جيد! يمكنك التحسن.';
  } else {
    msg = '🔄 لا بأس، حاول مرة أخرى!';
  }
  
  quizFeedbackDisplay.innerHTML = `
    <p>لقد أنهيت الاختبار!</p>
    <p>✅ ${fromNumber(quiz.correctCount)} من ${fromNumber(quiz.totalQuestions)} (${percent}%) - ${msg}</p>
  `;
  quizTimeBar.style.width = '0%';
}

// Initial setup
createNumberButtons();
switchLang(true); // Default to Arabic
selectLevel('مبتدئ');
openTab('tab-train', document.getElementById('tab-train-btn'));
</script>

</body>
</html>